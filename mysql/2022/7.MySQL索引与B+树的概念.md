# MySQL索引与B+树的概念

要说到在数据库相关的知识中，最吸引人的是什么，估计 80% 以上的人都会脱口而出 索引 这个词。我们都知道，这玩意真的好用，非常方便，而且往往优化 MySQL 的第一步就是去建立索引。那么今天，我们就开始学习了解索引这一块的内容，首先当然还是与索引相关的概念。

## 索引

索引是什么意思？太多教程太多书都会讲到，最典型的例子，去图书馆找书。我们要在一个大型的图书管找一本书，怎么找呢？我们可以先问图书馆的工作人员，比如说找一本 MySQL 相关的书籍。他会告诉你在 电脑科技 相关的书架附近，然后你走到电脑科技区域，会发现有好几排书架，不过每个书架上又会写着 编程、操作系统、网络、办公软件、数据库 等标签。当然，有的书店不一定会把数据库这个分类单独放到一排书架上，所以你也可以到编程相关的书架下面去找。

好了，找到大范围的书架后，你就可以在书架前一本一本的看书名，最后找到你想要的书。

假设，我们假设一种情况，你去的是一个刚开业的书店，书籍还没有经过整理分类，这时候要找一本书，你就得一本一本地看过去。有什么想法？没错，这就是线性查找 O(n) 的时间复杂度。而像上面一样有分类区域，也有分类书架呢？至少是折半，甚至是 Log 级别，效率是不是一下就快了很多。

在数据库中，其实情况也是和上面类似的。一张没有任何索引的表中的数据，就像是胡乱摆放的书库，要找到一条数据你就需要一条一条的查找。数据少的时候问题不大，毕竟计算机的性能已经很强悍了，但是几百上千万甚至是上几十亿的数据，即使是最高配的计算机，也会逐渐产生性能瓶颈。而索引，就是根据指定的索引字段，建立相关的书架分类，让程序根据索引规则能够快速地查找到需要的数据。

生活中其实索引非常常见，我们说了书店，其实每本书的目录，你写的论文目录，公司的员工花名册，组织架构等等，都可以看作是索引。概念好理解，那么索引究竟是如何让我们的查找变快的呢？这就要说到它的数据结构了。

## B+树

但凡提到索引，必提 B+树 。之前我们在学习数据结构的时候，讲过树、二叉树，也提到过 B+树 ，但真正要讲这个东西，还是要放到 MySQL ，也就是数据库相关的知识中进行学习。

首先我们要明确的是概念是 页 这个关键词。对于索引的存储来说，都是存储在 页 这个结构中，它有页头，也有数据单元，但是，需要注意的一点是，在 InnoDB 这个存储格式中，只有主键索引最底层的页中会存储真实的数据信息。其它层次以及其它索引结构，最终存储的只是主键。因此，使用普通索引查到到的其实是主键，然后根据主键再去查找真实的主键索引中的数据。这个操作叫做 回表 。这个概念我们在之后讲覆盖索引的时候还会说到。

而在 MyISAM 存储格式中，主键索引和普通索引记录的都是数据位置，它的索引是和数据完全分开的，因此，任何索引都有回表操作。

索引页的格式就像下面的图一样。

![./img/71.jpg](./img/71.jpg)

我们有一个根节点，下面还有一层目录节点，一般来说目录节点会按顺序记录id范围，之后就是底层的数据页，数据页一般存储 16k 的数据，按数据量来看一般最少2条数据。每个页都是和父子页以及兄弟页存在关联，其实内部就是链式存储的树结构。

当我们要查找一条数据时，比如我们查找 id 为 222 的数据，首页就是二分法快速定位到目录页，然后目录页中再二分法快速定位到数据页，最后在数据页中遍历获得真实的数据。

上述内容就是一个主键索引的 B+树 实现。注意，顺序很重要，不管是数字类型的索引还是字符串类型的索引，都会在 B+树 中进行排序，这个概念会影响到之后的 WHERE 条件优化以及 ORDER BY 相关的内容。之所以在某些情况下，ORDER BY 的速度也非常快，正是因为索引早就已经将数据排好了序。

普通索引的结构其实也是类似的，但是底层最后存储的不是真实数据，而是主键ID，这个我们就不单独说了，在这里我们再重点看的就是联合索引，也就是多个字段的索引是怎么建树的。

![./img/72.jpg](./img/72.jpg)

假设我们给 a、b、c 三个字段建立联合索引，那么它会一层一层的建立索引，也就是说，a 下面包含 b ，b 下面包含 c ，最后形成一颗很大的层次很多的树。其实这也就是在数据库中最经常讲到的写 WHERE 语句要遵循 最左匹配 原则的原因。如果我们的查询条件能够按照顺序以 a->b->c 的形式查找，那么索引的利用率也可以达到最大，效率也是最好的。

普通索引和联合索引最底层的数据页存储的都是主键id，同时在目录以及上层页也有存储这些字段自己的值，因此，如何只是查询索引相关的字段，就可以避免回表，比如 select a,b,c from t where a=1 and b=1 and c=1 。这个就是 覆盖索引 的概念，意思就是我们的索引正好覆盖了要查询的字段，同时它也是面试官经常会问的为什么不要使用 * 来查询的原因之一。

## 总结

今天的内容非常偏概念，但也非常有用，其实 B+树 的内容远不止我讲的这么简单，在页的基础上还有段的概念，还有页段的内部数据结构问题。这些内容可以大家有兴趣的可以参考更加详细的资料。

整体来说，其实有上面的内容我们就可以大概了解到数据库中的索引以及B+树是如何实现索引的。总之，索引以及相应的知识是我们学习 MySQL 绕不过去的一个坎，也是我们需要不断深入学习的内容，下一篇我们就来看看如何分析一条语句的索引情况。

参考文档：

《MySQL是怎样运行的》
